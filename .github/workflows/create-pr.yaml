name: Create or Update PR

on:
  push:
    branches:
      - development
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Fetch main branch
        run: |
          git fetch origin main:refs/remotes/origin/main

      - name: Check for differences
        id: diff
        run: |
          if git diff --quiet HEAD origin/main; then
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "No differences between ${{ github.ref_name }} and main"
          else
            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "Differences found between ${{ github.ref_name }} and main"
          fi

      - name: Create Pull Request
        if: steps.diff.outputs.has_diff == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Check if PR already exists
          existing_pr=$(gh pr list --head ${{ github.ref_name }} --base main --json number --jq '.[0].number')

          if [ -z "$existing_pr" ]; then
            echo "Creating new PR from ${{ github.ref_name }} to main"
            gh pr create \
              --title "feat: ${{ github.ref_name }}" \
              --body "Automated PR from branch \`${{ github.ref_name }}\` to \`main\`

            Branch: \`${{ github.ref_name }}\`
            Triggered by: @${{ github.actor }}" \
              --base main \
              --head ${{ github.ref_name }}
          else
            echo "PR #$existing_pr already exists for ${{ github.ref_name }} -> main"
          fi

  test:
    runs-on: ubuntu-latest
    needs: create-pull-request
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Set up Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
